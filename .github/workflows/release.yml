name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Python environment (for tests)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install test dependencies
      - name: Install Homebrew deps
        run: brew install shunit2

      # Python tests
      - name: Run Python tests
        run: pytest tests/ -v

      # Shell tests
      - name: Run backend shell tests
        run: |
          for f in tests/backend/test_*.sh; do
            bash "$f"
          done

      # Extract version
      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      # Build Homebrew tarball (pure source + python backend)
      - name: Create release tarball
        id: create_tarball
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          DIST_NAME="ctp500-macos-cli-${VERSION}"
          DIST_DIR="dist/${DIST_NAME}"

          mkdir -p "${DIST_DIR}"

          # Copy entire repo except .git
          rsync -a --exclude='.git' ./ "${DIST_DIR}/"

          # Create tarball
          cd dist
          TARBALL="${DIST_NAME}.tar.gz"
          tar -czf "${TARBALL}" "${DIST_NAME}"
          cd ..

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | cut -d' ' -f1)
          echo "TARBALL=dist/${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "SHA256=${SHA256}" >> "$GITHUB_OUTPUT"

      # GitHub Release
      - name: Create/Upload Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TARBALL="${{ steps.create_tarball.outputs.TARBALL }}"

          gh release create "v${VERSION}" \
            "${TARBALL}" \
            --title "CTP500 macOS CLI v${VERSION}" \
            --notes "Release ${VERSION}" \
            --draft=false --prerelease=false || \
          gh release upload "v${VERSION}" "${TARBALL}" --clobber

      - name: Summary
        run: |
          echo "## Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "Version: ${{ steps.get_version.outputs.VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "SHA256: \`${{ steps.create_tarball.outputs.SHA256 }}\`" >> "$GITHUB_STEP_SUMMARY"
