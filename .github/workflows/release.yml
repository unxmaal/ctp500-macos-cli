name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      # ---------------------------------------------------------
      # Checkout repo
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Python toolchain
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # Install Python deps (pytest + runtime deps)
      # ---------------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pillow bleak

      # ---------------------------------------------------------
      # Install shunit2 for backend tests
      # ---------------------------------------------------------
      - name: Install Homebrew test dependencies
        run: brew install shunit2

      # ---------------------------------------------------------
      # Backend + Python tests
      # ---------------------------------------------------------
      - name: Run pytest suite
        run: pytest tests/ -v

      - name: Run backend shell tests
        run: |
          for f in tests/backend/test_*.sh; do
            bash "$f"
          done

      # ---------------------------------------------------------
      # Extract tag version
      # ---------------------------------------------------------
      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Build Homebrew tarball (NO PyInstaller, Python-backend only)
      # ---------------------------------------------------------
      - name: Create release tarball
        id: create_tarball
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          DIST_NAME="ctp500-macos-cli-${VERSION}"
          DIST_DIR="dist/${DIST_NAME}"

          mkdir -p "${DIST_DIR}"/{files,Formula,docs,tests/backend/fixtures}

          cp files/ctp500.py "${DIST_DIR}/files/"
          cp files/backend_functions.sh "${DIST_DIR}/files/"
          cp files/CTP500.ppd "${DIST_DIR}/files/"
          cp files/ctp500.conf "${DIST_DIR}/files/"

          cp Formula/ctp500-printer.rb "${DIST_DIR}/Formula/"
          cp README.md "${DIST_DIR}/"
          cp docs/*.md "${DIST_DIR}/docs/" 2>/dev/null || true
          cp tests/backend/*.sh "${DIST_DIR}/tests/backend/"
          cp tests/backend/fixtures/* "${DIST_DIR}/tests/backend/fixtures/"

          cd dist
          TARBALL="${DIST_NAME}.tar.gz"
          tar -czf "${TARBALL}" "${DIST_NAME}"
          cd ..

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | cut -d' ' -f1)

          echo "TARBALL=dist/${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "SHA256=${SHA256}" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Create or update GitHub release
      # ---------------------------------------------------------
      - name: Upload Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TARBALL="${{ steps.create_tarball.outputs.TARBALL }}"

          gh release create "v${VERSION}" \
            "${TARBALL}" \
            --title "CTP500 macOS CLI v${VERSION}" \
            --notes "Automated release for version ${VERSION}" \
            --draft=false --prerelease=false || \
          gh release upload "v${VERSION}" "${TARBALL}" --clobber

      # ---------------------------------------------------------
      # Summary
      # ---------------------------------------------------------
      - name: Summary
        run: |
          echo "## Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "Version: ${{ steps.get_version.outputs.VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "SHA256: \`${{ steps.create_tarball.outputs.SHA256 }}\`" >> "$GITHUB_STEP_SUMMARY"
