name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build deps
      run: brew install shunit2

    - name: Install Python deps
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install pyinstaller

    - name: Run Python tests
      run: pytest tests/ -v

    - name: Run shell tests
      run: |
        for f in tests/backend/test_*.sh; do
          echo "Running: $f"
          bash "$f"
        done

    - name: Extract version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

    - name: Build binary
      run: |
        pyinstaller ctp500_ble_cli.spec
        chmod +x dist/ctp500_ble_cli

    - name: Deep-sign binary
      run: |
        codesign --force --deep -s - \
          --entitlements entitlements.plist \
          dist/ctp500_ble_cli
        codesign -dv --verbose=4 dist/ctp500_ble_cli

    - name: Create distribution tarball
      id: create_tarball
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        NAME="ctp500-macos-cli-${VERSION}"
        ROOT="dist/${NAME}"

        mkdir -p "${ROOT}/"{bin,files,Formula,docs,tests/backend/fixtures}

        cp dist/ctp500_ble_cli "${ROOT}/bin/"
        cp files/* "${ROOT}/files/"
        cp Formula/ctp500-printer.rb "${ROOT}/Formula/"
        cp README.md "${ROOT}/"
        cp docs/* "${ROOT}/docs/" 2>/dev/null || true
        cp tests/backend/*.sh "${ROOT}/tests/backend/"
        cp tests/backend/fixtures/* "${ROOT}/tests/backend/fixtures/"

        # Proper directory-preserving tarball (NOT FLAT)
        cd dist
        tar -czf "${NAME}.tar.gz" "${NAME}"
        cd ..

        SHA256=$(shasum -a 256 "dist/${NAME}.tar.gz" | cut -d ' ' -f1)

        echo "SHA256=${SHA256}" >> "$GITHUB_OUTPUT"
        echo "TARBALL=dist/${NAME}.tar.gz" >> "$GITHUB_OUTPUT"

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        TARBALL="${{ steps.create_tarball.outputs.TARBALL }}"

        gh release create "v${VERSION}" \
          "$TARBALL" \
          --title "CTP500 macOS CLI v${VERSION}" \
          --notes "Automated release" \
          --draft=false \
          --prerelease=false \
        || gh release upload "v${VERSION}" "$TARBALL" --clobber

    - name: Summary
      run: |
        echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**SHA256:** \`${{ steps.create_tarball.outputs.SHA256 }}\`" >> $GITHUB_STEP_SUMMARY
