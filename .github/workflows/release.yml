name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      # ---------------------------------------------------------
      # Checkout repo
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Python toolchain
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Homebrew test dependencies
        run: brew install shunit2

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pyinstaller

      # ---------------------------------------------------------
      # Tests
      # ---------------------------------------------------------
      - name: Run Python tests
        run: pytest tests/ -v

      - name: Run shell backend tests
        run: |
          for f in tests/backend/test_*.sh; do
            bash "$f"
          done

      # ---------------------------------------------------------
      # Extract tag version
      # ---------------------------------------------------------
      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Build binary
      # ---------------------------------------------------------
      - name: Build binary with PyInstaller
        run: |
          pyinstaller ctp500_ble_cli.spec
          chmod +x dist/ctp500_ble_cli

      # ---------------------------------------------------------
      # Ad-hoc code signing with entitlements
      # ---------------------------------------------------------
      - name: Sign binary
        run: |
          codesign --force --deep -s - \
            --entitlements entitlements.plist \
            dist/ctp500_ble_cli

          # Correct verification command
          codesign -dv --verbose=4 dist/ctp500_ble_cli || true

      # ---------------------------------------------------------
      # Build Homebrew-compliant tarball
      # ---------------------------------------------------------
      - name: Create release tarball
        id: create_tarball
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          DIST_NAME="ctp500-macos-cli-${VERSION}"
          DIST_DIR="dist/${DIST_NAME}"

          mkdir -p "${DIST_DIR}"/{bin,files,Formula,docs,tests/backend/fixtures}

          cp dist/ctp500_ble_cli "${DIST_DIR}/bin/"

          cp files/ctp500 "${DIST_DIR}/files/"
          cp files/backend_functions.sh "${DIST_DIR}/files/"
          cp files/CTP500.ppd "${DIST_DIR}/files/"
          cp files/ctp500.conf "${DIST_DIR}/files/"

          cp Formula/ctp500-printer.rb "${DIST_DIR}/Formula/"
          cp README.md "${DIST_DIR}/"
          cp docs/*.md "${DIST_DIR}/docs/" 2>/dev/null || true
          cp tests/backend/*.sh "${DIST_DIR}/tests/backend/"
          cp tests/backend/fixtures/* "${DIST_DIR}/tests/backend/fixtures/"

          cd "dist/${DIST_NAME}"
          TARBALL="../${DIST_NAME}.tar.gz"
          tar -czf "${TARBALL}" .
          cd ../..

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | cut -d' ' -f1)

          echo "TARBALL=dist/${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "SHA256=${SHA256}" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Release
      # ---------------------------------------------------------
      - name: Upload Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TARBALL="${{ steps.create_tarball.outputs.TARBALL }}"

          gh release create "v${VERSION}" \
            "${TARBALL}" \
            --title "CTP500 macOS CLI v${VERSION}" \
            --notes "Automated release for version ${VERSION}" \
            --draft=false --prerelease=false || \
          gh release upload "v${VERSION}" "${TARBALL}" --clobber

      # ---------------------------------------------------------
      # Summary
      # ---------------------------------------------------------
      - name: Summary
        run: |
          echo "## Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "Version: ${{ steps.get_version.outputs.VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "SHA256: \`${{ steps.create_tarball.outputs.SHA256 }}\`" >> "$GITHUB_STEP_SUMMARY"
