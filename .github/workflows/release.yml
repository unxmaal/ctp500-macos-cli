name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      # ---------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. Python environment (for building + tests)
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pyinstaller

      # ---------------------------------------------------------
      # 3. Run tests
      # ---------------------------------------------------------
      - name: Run Python tests
        run: pytest tests/ -v

      - name: Run shell script tests
        run: |
          brew install shunit2
          for test_file in tests/backend/test_*.sh; do
            echo "Running $(basename "$test_file")"
            bash "$test_file"
          done

      # ---------------------------------------------------------
      # 4. Extract version from tag
      # ---------------------------------------------------------
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # 5. Build PyInstaller binary
      # ---------------------------------------------------------
      - name: Build binary with PyInstaller
        run: |
          pyinstaller ctp500_ble_cli.spec
          chmod +x dist/ctp500_ble_cli

      # ---------------------------------------------------------
      # 6. Code signing with BLE entitlements
      # ---------------------------------------------------------
      - name: Deep code sign binary
        run: |
          codesign --force --deep -s - \
            --entitlements entitlements.plist \
            dist/ctp500_ble_cli

          echo "âœ“ Signature verification:"
          codesign -dv --ver
